/*********************************************************************************************
 * File Name:	ex01_getting_started.c
 *
 * Description: Provides API functions for accessing IOs, timing, and MQTT client
 *
 * Author:		Asst.Prof.Dr.Santi Nuratch
 * 				Embedded Computing and Control Laboratory		: ECC-Lab
 * 				Control System and Instrumentation Engineering 	: INC
 *				King Mongkut's University of Technology Thonburi: KMUTT
 *
 * Update:		06 December 2020 (Initial version)
 *
 *********************************************************************************************/

/*********************************************************************************************
####### ####### ######   #####  #     # #     #    ######     #    #       #       #     #
   #    #     # #     # #     # #     # ##    #    #     #   # #   #       #        #   #
   #    #     # #     # #       #     # # #   #    #     #  #   #  #       #         # #
   #    #     # ######  #  #### #     # #  #  #    ######  #     # #       #          #
   #    #     # #       #     # #     # #   # #    #   #   ####### #       #          #
   #    #     # #       #     # #     # #    ##    #    #  #     # #       #          #
   #    ####### #        #####   #####  #     #    #     # #     # ####### #######    #
**********************************************************************************************/



/*********************************************************************************************
 * Include File                                                                              *
 *********************************************************************************************/
#include <main.h>




/*********************************************************************************************
 * APPLICATION BEGIN                                                                         *
 *********************************************************************************************/

/*
 *********************************************************************************************
 *                                 OUTPUT/INPUT DESCRIPTION                                  *
 *********************************************************************************************
 * DIGITAL OUTPUT PORTS                                                                      *
 *********************************************************************************************
 * +----------+----------+--------+---------------------+------------------------------------+
 * |   NAME   |   GPIO   |   PIN  |  GPIOx, GPIO_PIN_x  |             Description            |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |    A0    |   GPIOC  |    5   |  GPIOC, GPIO_PIN_5  | CN4 PIN1 - Digital Output          |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |    A1    |   GPIOC  |    4   |  GPIOC, GPIO_PIN_4  | CN4 PIN2 - Digital Output          |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |    A2    |   GPIOC  |    5   |  GPIOC, GPIO_PIN_3  | CN4 PIN3 - Digital Output          |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |    A3    |   GPIOC  |    2   |  GPIOC, GPIO_PIN_2  | CN4 PIN4 - Digital Output          |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |    A4    |   GPIOC  |    1   |  GPIOC, GPIO_PIN_1  | CN4 PIN5 - Digital Output          |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |    A5    |   GPIOC  |    0   |  GPIOC, GPIO_PIN_0  | CN4 PIN6 - Digital Output          |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |   LED1   |   GPIOA  |    5   |  GPIOA, GPIO_PIN_5  | LD1 - Built-in GREEN LED           |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |   LED2   |   GPIOB  |   14   |  GPIOB, GPIO_PIN_14 | LD2 - Built-in GREEN LED           |
 * +----------+----------+--------+---------------------+------------------------------------+
 * |   LED3   |   GPIOC  |    9   |  GPIOC, GPIO_PIN_9  | LD2&LD4 - Built-in BLUE/ORANGE LED |
 * +----------+----------+--------+---------------------+------------------------------------+
 *
 * +-----------------------------------------------------------------------------------------+
 * | Examples:                                                                               |
 * +-----------------------------------------------------------------------------------------+
 * |    HAL_GPIO_WritePin(GPIOx, GPIO_PIN_x, GPIO_PIN_RESET);                                |
 * +-----------------------------------------------------------------------------------------+
 * +    HAL_GPIO_WritePin(GPIOx, GPIO_PIN_x, GPIO_PIN_SET);                                  |
 * +-----------------------------------------------------------------------------------------+
 * +    HAL_GPIO_TogglePin(GPIOx, GPIO_PIN_x);                                               |
 * +-----------------------------------------------------------------------------------------+
 *
 *
 *********************************************************************************************
 * DIGITAL INPUT PORT                                                                        *
 *********************************************************************************************
 * +----------+----------+--------+---------------------+------------------------------------+
 * |   NAME   |   GPIO   |   PIN  |  GPIOx, GPIO_PIN_x  |             Description            |
 * +----------+----------+--------+---------------------+------------------------------------+
 * | BLUE SW  |   GPIOC  |   13   |  GPIOC, GPIO_PIN_13 | BLUE SWITCH - Built-in Push Button |
 * +----------+----------+--------+---------------------+------------------------------------+
 *
 * +-----------------------------------------------------------------------------------------+
 * | Examples:                                                                               |
 * +-----------------------------------------------------------------------------------------+
 * |    if (HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13) == GPIO_PIN_RESET) {...}                    |
 * +-----------------------------------------------------------------------------------------+
 * |    if (HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13) == GPIO_PIN_RESET) {...}                    |
 * +-----------------------------------------------------------------------------------------+
 */


/*********************************************************************************************
 * Global Variables                                                                          *
 *********************************************************************************************/
static MQTTClient *ptr_Client;


/*********************************************************************************************
 * Callback Functions                                                                        *
 *********************************************************************************************/
void mqtt_message_received(MessageData* data) {
	printf("\n\n**mqtt_message_received()\n\n");
	char topicBuffer[64]={0};
	int len = data->topicName->lenstring.len;
	memcpy(topicBuffer, data->topicName->lenstring.data,  len);

	char payload[64]={0};
	memcpy(payload, data->message->payload, data->message->payloadlen);

	printf("Topic:  %s\r\nPayload: %s\r\n", topicBuffer, payload);
}


void mqtt_connected(MQTTClient *client, const char *deviceId) {
	printf("\n\n**mqtt_connected() %s\n\n", deviceId);
	ptr_Client = client;
	Mqtt_Subscribe(client, "/hello/world", mqtt_message_received);
}


void psw_pushed(uint32_t count) {
	printf("\nbtn_pushed_callback()\n");
	if(Mqtt_CanPublish()){
		Mqtt_SensorsPublish();
	}
	else if(Mqtt_CanPublish()){
		Mqtt_Publish(ptr_Client, "/hello/world", "pushed callback!") ;
	}
}


void psw_holding(uint32_t count) {
	printf("\nbtn_holding_callback()\n");
	if(Mqtt_CanPublish()){
		Mqtt_SensorsPublishContinuous(2);
	}
	else if(Mqtt_CanPublish()){
		Mqtt_Publish(ptr_Client, "/hello/world", "holding callback!");
	}

}


void ticked_callback(uint32_t ticks) {
	if(ticks % 1000 == 0 && Clk_IsRtcUpdated()) {
		printf("time: %s\r\n", Clk_GetString(1));
	}
}



/*********************************************************************************************
 ****                                                                                     ****
 **** TGR2021 MAIN FUNCTION                                                               ****
 ****                                                                                     ****
 *********************************************************************************************/

void TGR_Main(void) {

	/*******************************************************************************************************
	 ****
	 **** BASIC EXAMPLE START
	 ****
	 *******************************************************************************************************/

	Psw_SetPushedCallback(psw_pushed);
	Psw_SetHoldingCallback(psw_holding);
	Mqtt_SetConnectedCallback(mqtt_connected);
	Clk_SetTickCallback(ticked_callback);


	/* Example 1.
	uint32_t t0, t1;
	t0 = HAL_GetTick();
	t1 = t0;

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_RESET);	// LED1
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_14, GPIO_PIN_SET);	// LED2

	bool bit = true;
	while(1) {
		t1 = HAL_GetTick();
		if( (t1 - t0) > 200) {
			t0 = t1;
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5);			// LED1
			HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_14);			// LED2
			HAL_GPIO_WritePin(GPIOC, GPIO_PIN_9, bit);		// LED3
			bit = !bit;
		}
	}
	*/

	/* Example 2
	uint32_t counter = 0;
	while(1) {
		HAL_Delay(1);
		if (HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13) == GPIO_PIN_RESET) {
			if(++counter > 100) {
				counter = 0;
				HAL_GPIO_TogglePin(GPIOC, GPIO_PIN_9);
			}
		}
	}
	*/

	/*******************************************************************************************************
	 ****
	 **** BASIC EXAMPLE END
	 ****
	 *******************************************************************************************************/



	/*******************************************************************************************************
	 ****
	 **** MQTT CLIENT START
	 ****
	 *******************************************************************************************************/
	GenericMQTT_Client_Run(0);
	while(1);
}

/*********************************************************************************************
 ****                                                                                     ****
 **** END OF MAIN FUNCTION                                                                ****
 ****                                                                                     ****
 *********************************************************************************************/


/*
	####### ####### ######   #####  #     # #     #    ######     #    #       #       #     #
	   #    #     # #     # #     # #     # ##    #    #     #   # #   #       #        #   #
	   #    #     # #     # #       #     # # #   #    #     #  #   #  #       #         # #
	   #    #     # ######  #  #### #     # #  #  #    ######  #     # #       #          #
	   #    #     # #       #     # #     # #   # #    #   #   ####### #       #          #
	   #    #     # #       #     # #     # #    ##    #    #  #     # #       #          #
	   #    ####### #        #####   #####  #     #    #     # #     # ####### #######    #
*/


















